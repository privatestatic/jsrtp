name: Release
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
      nextVersion:
        description: 'Next version after release (-SNAPSHOT will be added automatically)'
        required: true

# Prevent concurrent releases
concurrency:
  group: release
  cancel-in-progress: false

jobs:
  # Pre-check job to provide clear error message for wrong branch
  check-branch:
    runs-on: ubuntu-latest
    permissions: {}
    steps:
      - name: Check branch
        if: github.ref != 'refs/heads/main'
        run: |
          echo "❌ Error: Releases can only be created from the 'main' branch."
          echo "Current branch: ${{ github.ref_name }}"
          echo "Please switch to 'main' and try again."
          exit 1

  release:
    runs-on: ubuntu-latest
    needs: check-branch
    permissions:
      contents: write

    steps:
      - name: Validate version format
        run: |
          VERSION="$(echo "${{ github.event.inputs.version }}" | xargs)"
          NEXT_VERSION="$(echo "${{ github.event.inputs.nextVersion }}" | xargs)"
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$'; then
            echo "❌ Invalid version format: '$VERSION'"
            echo "Expected format: X.Y.Z or X.Y.Z-suffix (e.g., 1.0.0 or 1.0.0-RC1)"
            exit 1
          fi
          if ! echo "$NEXT_VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$'; then
            echo "❌ Invalid next version format: '$NEXT_VERSION'"
            echo "Expected format: X.Y.Z or X.Y.Z-suffix (e.g., 1.1.0 or 2.0.0-RC1)"
            exit 1
          fi
          echo "✅ Version formats are valid"

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if version already exists
        run: |
          if git tag -l | grep -qE "^v${{ github.event.inputs.version }}$"; then
            echo "❌ Error: Version v${{ github.event.inputs.version }} already exists!"
            echo "Existing tags:"
            git tag -l | sort -V | tail -5
            echo ""
            echo "Please use a new version number."
            exit 1
          fi
          echo "✅ Version v${{ github.event.inputs.version }} is available"

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: maven

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Print given versions
        run: echo "Release version is ${{ github.event.inputs.version }} and next version is ${{ github.event.inputs.nextVersion }}-SNAPSHOT"

      - name: Set release version
        run: mvn -B versions:set -DnewVersion=${{ github.event.inputs.version }} -DgenerateBackupPoms=false

      - name: Build and verify
        run: mvn -B verify -DskipNativeTests=true

      - name: Commit release version
        run: |
          git add pom.xml
          git commit -m "Release version ${{ github.event.inputs.version }}"
          git tag -a v${{ github.event.inputs.version }} -m "Release ${{ github.event.inputs.version }}"

      - name: Set next development version
        run: mvn -B versions:set -DnewVersion=${{ github.event.inputs.nextVersion }}-SNAPSHOT -DgenerateBackupPoms=false

      - name: Commit next development version
        run: |
          git add pom.xml
          git commit -m "Prepare for next development iteration ${{ github.event.inputs.nextVersion }}-SNAPSHOT"

      - name: Push changes and tags
        run: |
          git push origin ${{ github.ref_name }}
          git push origin v${{ github.event.inputs.version }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.event.inputs.version }}
          name: Release ${{ github.event.inputs.version }}
          generate_release_notes: true
          files: |
            target/*.jar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
